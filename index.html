<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>許阿桂試衣間 | 3D 實體生成</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/body-pix"></script>

    <style>
        body { margin: 0; background: #f5f5f7; font-family: sans-serif; overflow: hidden; }
        #canvas-box { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        .ui { position: relative; z-index: 10; height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: space-between; padding: 40px 0; pointer-events: none; }
        .ui * { pointer-events: auto; }
        h1 { font-size: 32px; color: #1d1d1f; margin: 0; font-weight: 700; }
        .status { background: #fff; padding: 6px 20px; border-radius: 20px; color: #0071e3; font-size: 14px; margin-top: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .btns { display: flex; gap: 20px; margin-bottom: 30px; }
        .btn-apple { background: #fff; border: 1px solid #d2d2d7; padding: 18px 30px; border-radius: 18px; font-size: 15px; font-weight: 600; cursor: pointer; transition: 0.2s; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .btn-apple:hover { background: #0071e3; color: #fff; border-color: #0071e3; }
    </style>
</head>
<body>

<div id="canvas-box"></div>

<div class="ui">
    <div style="text-align: center;">
        <h1>許阿桂 <span style="color:#0071e3;">試衣間</span></h1>
        <div id="msg" class="status">正在由幾何算法生成 3D 實體...</div>
    </div>

    <div class="btns">
        <label class="btn-apple">＋ 合成上衣<input type="file" hidden onchange="startFitting(this, 'top')"></label>
        <label class="btn-apple">＋ 合成下著<input type="file" hidden onchange="startFitting(this, 'bottom')"></label>
    </div>
</div>

<script>
    let scene, camera, renderer, modelGroup, aiNet;

    // 1. 建立 3D 實體
    function init3D() {
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0xf5f5f7);

        camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 100);
        camera.position.set(0, 0, 5);

        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.getElementById('canvas-box').appendChild(renderer.domElement);

        // 打光：環境光 + 聚光燈，確保立體感
        scene.add(new THREE.AmbientLight(0xffffff, 0.8));
        const spot = new THREE.DirectionalLight(0xffffff, 0.6);
        spot.position.set(5, 10, 7.5);
        scene.add(spot);

        // 生成 A-Pose 模特兒
        modelGroup = new THREE.Group();
        const material = new THREE.MeshStandardMaterial({ color: 0xcccccc, roughness: 0.4 });

        // 軀幹
        const torso = new THREE.Mesh(new THREE.CylinderGeometry(0.4, 0.35, 1.3, 32), material);
        // 頭部
        const head = new THREE.Mesh(new THREE.SphereGeometry(0.25, 32, 32), material);
        head.position.y = 0.95;
        // A-Pose 雙臂
        const armL = new THREE.Mesh(new THREE.CylinderGeometry(0.08, 0.07, 0.8), material);
        armL.position.set(-0.6, 0.4, 0); armL.rotation.z = 0.6;
        const armR = new THREE.Mesh(new THREE.CylinderGeometry(0.08, 0.07, 0.8), material);
        armR.position.set(0.6, 0.4, 0); armR.rotation.z = -0.6;
        // 雙腿
        const legL = new THREE.Mesh(new THREE.CylinderGeometry(0.12, 0.1, 1.1), material);
        legL.position.set(-0.2, -1.1, 0);
        const legR = new THREE.Mesh(new THREE.CylinderGeometry(0.12, 0.1, 1.1), material);
        legR.position.set(0.2, -1.1, 0);

        modelGroup.add(torso, head, armL, armR, legL, legR);
        scene.add(modelGroup);

        animate();
        loadAI();
    }

    function animate() {
        requestAnimationFrame(animate);
        if (modelGroup) modelGroup.rotation.y += 0.01; // 實時旋轉展示 3D 實體
        renderer.render(scene, camera);
    }

    async function loadAI() {
        aiNet = await bodyPix.load();
        document.getElementById('msg').innerText = "3D A-Pose 實體已生成";
    }

    // 2. 衣服貼合邏輯
    async function startFitting(input, type) {
        if (!input.files[0] || !aiNet) return;
        document.getElementById('msg').innerText = "AI 正在將衣服包覆至 3D 實體...";

        const img = new Image();
        img.src = URL.createObjectURL(input.files[0]);
        img.onload = async () => {
            const canvas = document.createElement('canvas');
            canvas.width = 512; canvas.height = 512;
            const ctx = canvas.getContext('2d');
            
            // 模擬將圖片映射為 3D 紋理
            ctx.fillStyle = "#cccccc";
            ctx.fillRect(0, 0, 512, 512);
            ctx.drawImage(img, 128, type === 'top' ? 60 : 260, 256, 256);

            const tex = new THREE.CanvasTexture(canvas);
            const fitMat = new THREE.MeshStandardMaterial({ map: tex });

            modelGroup.traverse(node => {
                if (node.isMesh) node.material = fitMat;
            });
            document.getElementById('msg').innerText = "合成完成";
        };
    }

    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    });

    init3D();
</script>
</body>
</html>
