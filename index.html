<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>許阿桂試衣間 | 3D Reality X</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/body-pix"></script>

    <style>
        :root { --apple-blue: #0071e3; --bg: #ffffff; }
        body { background: var(--bg); font-family: -apple-system, sans-serif; margin: 0; overflow: hidden; }
        #canvas-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        .ui-overlay { position: relative; z-index: 10; pointer-events: none; height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: space-between; padding: 50px 0; }
        .ui-element { pointer-events: auto; text-align: center; }
        h1 { font-size: 32px; font-weight: 700; letter-spacing: -1px; margin: 0; }
        .status-bar { font-size: 13px; color: var(--apple-blue); font-weight: 600; margin-top: 10px; background: rgba(255,255,255,0.7); padding: 5px 15px; border-radius: 20px; backdrop-filter: blur(10px); }
        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; width: 90%; max-width: 440px; }
        .btn-apple { background: rgba(255,255,255,0.9); border: 1px solid rgba(0,0,0,0.1); padding: 22px; border-radius: 24px; font-size: 15px; font-weight: 600; cursor: pointer; transition: 0.3s; box-shadow: 0 8px 30px rgba(0,0,0,0.04); }
        .btn-apple:hover { transform: translateY(-2px); box-shadow: 0 12px 40px rgba(0,0,0,0.08); }
        #scanner { position: absolute; width: 100%; height: 3px; background: var(--apple-blue); box-shadow: 0 0 15px var(--apple-blue); top: 50%; display: none; animation: scan 2s infinite; z-index: 5; }
        @keyframes scan { 0% { top: 30%; opacity: 0; } 50% { opacity: 1; } 100% { top: 70%; opacity: 0; } }
    </style>
</head>
<body>

<div id="canvas-container"></div>
<div id="scanner"></div>

<div class="ui-overlay">
    <div class="ui-element">
        <h1>許阿桂 <span style="color:var(--apple-blue)">試衣間</span></h1>
        <div id="status" class="status-bar">正在載入 3D 試衣空間...</div>
    </div>

    <div class="controls ui-element">
        <label class="btn-apple">＋ 合成上衣<input type="file" hidden onchange="processGarment(this, 'top')"></label>
        <label class="btn-apple">＋ 合成下著<input type="file" hidden onchange="processGarment(this, 'bottom')"></label>
    </div>
</div>

<script>
    let scene, camera, renderer, mannequin, net;
    const loader = new THREE.GLTFLoader();

    // 1. 初始化 3D 舞台
    function init3D() {
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0xffffff);
        camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 0, 5);

        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        // 光影設計
        const ambient = new THREE.AmbientLight(0xffffff, 0.8);
        scene.add(ambient);
        const directional = new THREE.DirectionalLight(0xffffff, 0.5);
        directional.position.set(5, 10, 7.5);
        scene.add(directional);

        // 預設生成一個立體幾何體，防止 GLB 載入失敗時畫面空白
        const geometry = new THREE.CapsuleGeometry(0.6, 1.8, 10, 20);
        const material = new THREE.MeshStandardMaterial({ color: 0xe5e5e5, roughness: 0.7 });
        mannequin = new THREE.Mesh(geometry, material);
        mannequin.position.y = -0.5;
        scene.add(mannequin);

        // 嘗試載入精細 3D 模型
        loader.load('https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Models/master/2.0/SimpleSkinning/glTF-Binary/SimpleSkinning.glb', 
            (gltf) => {
                scene.remove(mannequin); // 移除預設體
                mannequin = gltf.scene;
                mannequin.scale.set(0.018, 0.018, 0.018);
                mannequin.position.y = -1.8;
                scene.add(mannequin);
                document.getElementById('status').innerText = "3D 模特兒已就緒";
            },
            undefined, 
            () => { document.getElementById('status').innerText = "使用內建 3D 實體進行中"; }
        );

        animate();
    }

    function animate() {
        requestAnimationFrame(animate);
        if (mannequin) mannequin.rotation.y += 0.005;
        renderer.render(scene, camera);
    }

    // 2. 初始化 AI
    async function initAI() {
        net = await bodyPix.load();
    }

    // 3. AI 提取與 3D 貼合
    async function processGarment(input, type) {
        if (!input.files[0] || !net) return;
        
        const status = document.getElementById('status');
        const scanner = document.getElementById('scanner');
        status.innerText = `阿桂正在分析${type === 'top' ? '上衣' : '下著'}材質...`;
        scanner.style.display = 'block';

        const file = input.files[0];
        const img = new Image();
        img.src = URL.createObjectURL(file);

        img.onload = async () => {
            const seg = await net.segmentPersonBodyParts(img);
            const canvas = document.createElement('canvas');
            canvas.width = 1024; canvas.height = 1024;
            const ctx = canvas.getContext('2d');
            
            // 建立 AI 提取層
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = img.width; tempCanvas.height = img.height;
            const tCtx = tempCanvas.getContext('2d');
            tCtx.drawImage(img, 0, 0);
            const data = tCtx.getImageData(0, 0, img.width, img.height);
            
            const targets = type === 'top' ? [10, 11, 12, 13, 14, 15] : [16, 17, 18, 19];
            for (let i = 0; i < data.data.length; i += 4) {
                if (!targets.includes(seg.data[i / 4])) data.data[i + 3] = 0;
            }
            tCtx.putImageData(data, 0, 0);

            // 將衣服映射至 3D 紋理空間
            ctx.fillStyle = "#e5e5e5";
            ctx.fillRect(0, 0, 1024, 1024);
            ctx.drawImage(tempCanvas, 256, type === 'top' ? 100 : 500, 512, 512);

            const texture = new THREE.CanvasTexture(canvas);
            const newMaterial = new THREE.MeshStandardMaterial({ map: texture, roughness: 0.5 });

            // 慢慢合成完：使用淡入動畫
            let opacity = 0;
            newMaterial.transparent = true;
            newMaterial.opacity = 0;
            
            mannequin.traverse((o) => { if (o.isMesh) o.material = newMaterial; });

            const fadeIn = setInterval(() => {
                opacity += 0.1;
                newMaterial.opacity = opacity;
                if (opacity >= 1) {
                    clearInterval(fadeIn);
                    scanner.style.display = 'none';
                    status.innerText = "穿搭合成完畢";
                }
            }, 100);
        };
    }

    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    });

    init3D();
    initAI();
</script>
</body>
</html>
