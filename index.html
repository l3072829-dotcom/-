<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>許阿桂試衣間 | 3D AI Studio</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/body-pix"></script>

    <style>
        :root { --apple-blue: #0071e3; --bg: #f5f5f7; }
        body { background: var(--bg); font-family: -apple-system, sans-serif; margin: 0; overflow: hidden; color: #1d1d1f; }
        
        /* UI 層級 */
        .overlay { position: absolute; top: 0; width: 100%; height: 100%; pointer-events: none; display: flex; flex-direction: column; align-items: center; justify-content: space-between; padding: 40px 0; z-index: 10; }
        .ui-element { pointer-events: auto; }

        h1 { font-weight: 700; font-size: 28px; letter-spacing: -1px; margin: 0; }
        .status-tag { font-size: 13px; color: var(--apple-blue); font-weight: 600; background: rgba(255,255,255,0.8); padding: 5px 15px; border-radius: 20px; backdrop-filter: blur(5px); margin-top: 10px; }

        /* 3D 畫布 */
        #three-canvas { position: fixed; top: 0; left: 0; outline: none; }

        /* 控制面板 */
        .control-panel { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 90%; max-width: 400px; margin-bottom: 20px; }
        .up-card { background: white; padding: 20px 10px; border-radius: 22px; border: 1px solid rgba(0,0,0,0.1); font-size: 14px; font-weight: 600; text-align: center; cursor: pointer; transition: 0.3s; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .up-card:active { transform: scale(0.95); }
        .up-card.loading { background: #e8e8ed; color: #86868b; }

        /* 掃描線動畫 */
        .scan-line { position: absolute; top: 0; width: 100%; height: 2px; background: var(--apple-blue); box-shadow: 0 0 15px var(--apple-blue); display: none; animation: scanning 2s infinite; z-index: 5; }
        @keyframes scanning { from { top: 20%; opacity: 0; } 50% { opacity: 1; } to { top: 80%; opacity: 0; } }
    </style>
</head>
<body>

<canvas id="three-canvas"></canvas>
<div class="scan-line" id="scanner"></div>

<div class="overlay">
    <div class="ui-element" style="text-align: center;">
        <h1>許阿桂 <span style="color:var(--apple-blue)">試衣間</span></h1>
        <div id="status" class="status-tag">3D 空間初始化中...</div>
    </div>

    <div class="control-panel ui-element">
        <label class="up-card" id="label-top">＋ 合成上衣<input type="file" hidden onchange="handleAIUpload(this, 'top')"></label>
        <label class="up-card" id="label-bottom">＋ 合成下著<input type="file" hidden onchange="handleAIUpload(this, 'bottom')"></label>
    </div>
</div>

<script>
    let scene, camera, renderer, model, net;
    const MODEL_URL = 'https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Models/master/2.0/SimpleSkinning/glTF-Binary/SimpleSkinning.glb';

    // 1. 初始化 3D 引擎
    function initThree() {
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0xf5f5f7);
        
        camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 0, 5);

        renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('three-canvas'), antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));

        // 光源設定
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.7);
        scene.add(ambientLight);
        const sunLight = new THREE.DirectionalLight(0xffffff, 0.8);
        sunLight.position.set(5, 10, 7.5);
        scene.add(sunLight);

        // 載入 3D 模特兒
        const loader = new THREE.GLTFLoader();
        loader.load(MODEL_URL, (gltf) => {
            model = gltf.scene;
            model.scale.set(0.015, 0.015, 0.015);
            model.position.y = -1.5;
            
            // 初始材質：極簡白
            model.traverse((o) => {
                if (o.isMesh) o.material = new THREE.MeshStandardMaterial({ color: 0xeeeeee, roughness: 0.5 });
            });

            scene.add(model);
            document.getElementById('status').innerText = "阿桂已為您準備好 3D 模特兒";
        });

        animate();
    }

    function animate() {
        requestAnimationFrame(animate);
        if (model) model.rotation.y += 0.005; // 自動旋轉
        renderer.render(scene, camera);
    }

    // 2. 初始化 AI
    async function initAI() {
        net = await bodyPix.load();
    }

    // 3. AI 提取與 3D 貼合邏輯
    async function handleAIUpload(input, type) {
        if (!input.files[0] || !model) return;
        
        const status = document.getElementById('status');
        const scanner = document.getElementById('scanner');
        status.innerText = `阿桂正在掃描衣物特徵...`;
        scanner.style.display = 'block';

        const file = input.files[0];
        const img = new Image();
        img.src = URL.createObjectURL(file);

        img.onload = async () => {
            // AI 分割
            const segmentation = await net.segmentPersonBodyParts(img);
            
            const canvas = document.createElement('canvas');
            canvas.width = 1024; canvas.height = 1024;
            const ctx = canvas.getContext('2d');
            
            // 建立提取後的衣服畫布
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = img.width; tempCanvas.height = img.height;
            const tCtx = tempCanvas.getContext('2d');
            tCtx.drawImage(img, 0, 0);
            const imgData = tCtx.getImageData(0, 0, img.width, img.height);
            
            const targets = type === 'top' ? [10, 11, 12, 13, 14, 15] : [16, 17, 18, 19];
            for (let i = 0; i < imgData.data.length; i += 4) {
                if (!targets.includes(segmentation.data[i / 4])) imgData.data[i + 3] = 0;
            }
            tCtx.putImageData(imgData, 0, 0);

            // 將提取物畫入貼圖並水平翻轉補全 (簡單鏡像)
            ctx.clearRect(0, 0, 1024, 1024);
            ctx.drawImage(tempCanvas, 256, 100, 512, 600); 

            const texture = new THREE.CanvasTexture(canvas);
            texture.flipY = false;

            // 慢慢合成動畫邏輯
            let opacityObj = { val: 0 };
            const targetMaterial = new THREE.MeshStandardMaterial({ 
                map: texture, 
                transparent: true, 
                opacity: 0,
                roughness: 0.4
            });

            // 應用材質
            model.traverse((o) => {
                if (o.isMesh) {
                    o.material = targetMaterial;
                }
            });

            // 漸進顯影 (1.5秒慢慢合成)
            const fadeIn = setInterval(() => {
                opacityObj.val += 0.05;
                targetMaterial.opacity = opacityObj.val;
                if (opacityObj.val >= 0.9) {
                    clearInterval(fadeIn);
                    scanner.style.display = 'none';
                    status.innerText = "穿搭合成完畢";
                }
            }, 50);
        };
    }

    // 視窗調整
    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    });

    initThree();
    initAI();
</script>
</body>
</html>
