<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>許阿桂試衣間 | 3D 實體生成</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/body-pix"></script>

    <style>
        :root { --apple-blue: #0071e3; --bg: #f5f5f7; }
        body { margin: 0; background: var(--bg); font-family: -apple-system, sans-serif; overflow: hidden; }
        
        /* UI 層級：確保文字和按鈕永遠在最前面 */
        .ui-container { position: relative; z-index: 100; height: 100vh; pointer-events: none; display: flex; flex-direction: column; align-items: center; justify-content: space-between; padding: 40px 0; }
        .ui-element { pointer-events: auto; }
        
        h1 { font-size: 32px; font-weight: 700; color: #1d1d1f; margin: 0; }
        .status-pill { background: white; padding: 8px 20px; border-radius: 20px; color: var(--apple-blue); font-size: 14px; font-weight: 600; margin-top: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        
        .btn-group { display: flex; gap: 15px; margin-bottom: 20px; }
        .btn-apple { background: white; border: 1px solid #d2d2d7; padding: 18px 30px; border-radius: 18px; font-size: 15px; font-weight: 600; cursor: pointer; transition: 0.2s; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .btn-apple:hover { background: var(--apple-blue); color: white; border-color: var(--apple-blue); }

        /* 3D 畫布容器 */
        #render-target { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
    </style>
</head>
<body>

<div id="render-target"></div>

<div class="ui-layer">
    <div class="ui-container">
        <div class="ui-element" style="text-align: center;">
            <h1>許阿桂 <span style="color:var(--apple-blue)">試衣間</span></h1>
            <div id="status" class="status-pill">3D 幾何模型生成中...</div>
        </div>

        <div class="btn-group ui-element">
            <label class="btn-apple">＋ 合成上衣<input type="file" hidden onchange="processAI(this, 'top')"></label>
            <label class="btn-apple">＋ 合成下著<input type="file" hidden onchange="processAI(this, 'bottom')"></label>
        </div>
    </div>
</div>

<script>
    let scene, camera, renderer, mannequinGroup, net;

    function init() {
        // 1. 初始化 3D 場景
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0xf5f5f7);

        camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 100);
        camera.position.set(0, 0, 5);

        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.getElementById('render-target').appendChild(renderer.domElement);

        // 2. 打光 (讓模型有立體感)
        const ambient = new THREE.AmbientLight(0xffffff, 0.7);
        scene.add(ambient);
        const sun = new THREE.DirectionalLight(0xffffff, 0.8);
        sun.position.set(5, 10, 7.5);
        scene.add(sun);

        // 3. 用幾何體「生成」3D 模特兒 (A-Pose)
        mannequinGroup = new THREE.Group();
        const mat = new THREE.MeshStandardMaterial({ color: 0xdddddd, roughness: 0.5 });

        // 身體各部位生成
        const torso = new THREE.Mesh(new THREE.CylinderGeometry(0.4, 0.3, 1.2, 32), mat);
        const head = new THREE.Mesh(new THREE.SphereGeometry(0.25, 32, 32), mat);
        head.position.y = 0.9;
        
        // A-Pose 雙手 (旋轉角度)
        const armL = new THREE.Mesh(new THREE.CylinderGeometry(0.08, 0.08, 0.8), mat);
        armL.position.set(-0.55, 0.3, 0); armL.rotation.z = 0.5;
        const armR = new THREE.Mesh(new THREE.CylinderGeometry(0.08, 0.08, 0.8), mat);
        armR.position.set(0.55, 0.3, 0); armR.rotation.z = -0.5;

        // 雙腳
        const legL = new THREE.Mesh(new THREE.CylinderGeometry(0.12, 0.1, 1.0), mat);
        legL.position.set(-0.2, -1.0, 0);
        const legR = new THREE.Mesh(new THREE.CylinderGeometry(0.12, 0.1, 1.0), mat);
        legR.position.set(0.2, -1.0, 0);

        mannequinGroup.add(torso, head, armL, armR, legL, legR);
        scene.add(mannequinGroup);

        animate();
        loadAI();
    }

    function animate() {
        requestAnimationFrame(animate);
        if (mannequinGroup) mannequinGroup.rotation.y += 0.01; // 讓模型旋轉展示立體感
        renderer.render(scene, camera);
    }

    async function loadAI() {
        net = await bodyPix.load();
        document.getElementById('status').innerText = "3D 實體模型已就緒";
    }

    // AI 處理並將衣服「貼」在 3D 實體上
    async function processAI(input, type) {
        if (!input.files[0] || !net) return;
        document.getElementById('status').innerText = "正在將服裝映射至 3D 實體...";

        const img = new Image();
        img.src = URL.createObjectURL(input.files[0]);
        img.onload = async () => {
            const seg = await net.segmentPersonBodyParts(img);
            const canvas = document.createElement('canvas');
            canvas.width = 512; canvas.height = 512;
            const ctx = canvas.getContext('2d');
            
            // 提取衣物 (簡化邏輯)
            ctx.fillStyle = "#dddddd";
            ctx.fillRect(0, 0, 512, 512);
            ctx.drawImage(img, 128, type === 'top' ? 50 : 250, 256, 256);

            const tex = new THREE.CanvasTexture(canvas);
            const clothingMat = new THREE.MeshStandardMaterial({ map: tex });

            // 將材質應用到 3D 幾何體
            mannequinGroup.traverse(node => {
                if (node.isMesh) node.material = clothingMat;
            });
            document.getElementById('status').innerText = "合成完成";
        };
    }

    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    });

    init();
</script>
</body>
</html>
